<html>

  <head>
    <title>Emoji test</title>
    <style>
    @font-face {
        font-family: emoji;
        src: url(/AppleColorEmoji.ttf);
    }
    </style>
  </head>

  <body>
    <p>When will he read a book? When the clock strikes five.</p>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>
      let PUNCTUATION=/([!"#\$%&'\(\)\*\+,-.\/:;\<=>\?@\[\]\^_`{\|}~])$/g;

      function cleanWord(word) {
        return {
          clean: word.replace(PUNCTUATION, "").toLowerCase(),
          ends: word.match(PUNCTUATION),
        }
      }

      function getEmoji(inword) {
        if (inword.length < 4) {
          return null;
        } else {
          return new Promise((resolve, reject) => {
            let word = cleanWord(inword);
            $.get("https://www.emojidex.com/api/v1/search/emoji?code_cont="+word.clean).then(function(i) {
              resolve({
                endsWith: word.ends,
                payload: i.emoji.reverse().find(i => i.unicode && i.unicode.length),
              });
            }, reject);
          });
        }
      }

      $(document).ready(function() {
        $("p").each(function(i) {
          let words = $(this).text().split(" ");

          // loop by words
          let promises = words.map(word => getEmoji(word));

          // loop through all promises and get the emoji for each word
          Promise.all(promises).then(emojis => {
            let text = emojis.map((emoji, ct) => {
              if (emoji && emoji.payload) {
                return "<span style='cursor: default;' title='"+words[ct]+"'>" +
                  String.fromCodePoint(parseInt(emoji.payload.unicode, 16)) +
                  "</span>" + (emoji.endsWith || "");
              } else {
                return words[ct]
              }
            }).join(" ");

            this.innerHTML = text;
            $(this).css("font-family", "emoji");
          });
        });
      });
    </script>
  </body>
</html>
